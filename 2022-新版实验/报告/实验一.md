# <center>实验一 环境配置</center>

## 一、实验目的

1. 掌握QEMU基本用法

2. 掌握ZNS SSD设备模拟方法

## 二、实验内容

1. 下载QEMU源代码并编译安装

2. 下载ubuntu 22.04镜像并在QEMU中安装

3. 在QEMU中模拟zns ssd

4. 启动QEMU的ubuntu操作系统，观察zns ssd是否安装成功

## 三、实验过程和步骤

由于在linux虚拟机上一直提示有空间问题，并且虚拟机上操作还是没有物理机来的实在，因此本次实验是在windows物理机下使用qemu完成。

### 1. 首先下载一下qemu的windows版本文件名为qemuXXX.exe，双击安装之后，检查版本。



![image-20221113123435289](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221113123435289.png)

### 2. 创建一块虚拟盘

```
qemu-img create -f qcow2 ubuntu.qcow2 100G
```

>  KVM虚拟机映像对于物理机来说是一个文件，这个文件主要可以有两种格式，一种就是原始ROW型，另一种是QCOW2型，qcow2型的特点是动态的，即时你给他分配的特别多，他仍然占用很少的空间

![image-20221113123537859](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221113123537859.png)

### 3. 再创建一块虚拟盘用于模拟NVME ZNS SSD

![image-20221113130754730](C:/Users/dell/AppData/Roaming/Typora/typora-user-images/image-20221113130754730.png)

### 4. 下载好对应版本的ubuntu镜像，然后安装

windows下git bash命令

```
./qemu-system-x86_64 -m 8G -smp 2 -boot order=dc -hda ubuntu.qcow2 -cdrom D:/linux_iso_ubuntu/ubuntu-22.04.1-live-server-amd64.iso
```

之后正常安装ubuntu

![image-20221113131239874](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221113131239874.png)

### 5. 安装完成后直接关闭qemu （重要！！！），然后启动系统

完成后直接关闭，然后重新启动，注意重新启动的时候不要加ubuntu镜像文件，如果加了就会重新安装。

windows下gitbash命令：

```
./qemu-system-x86_64 -name znstest -m 8G -smp 4 -hda ubuntu.qcow2 -net user,hostfwd=tcp:127.0.0.1:7777-:22,hostfwd=tcp:127.0.0.1:2222-:2000 -net nic -drive file=znsssd.qcow2,id=mynvme,format=raw,if=none -device nvme,serial=baz,id=nvme2 -device nvme-ns,id=ns2,drive=mynvme,nsid=2,logical_block_size=4096,physical_block_size=4096,zoned=true,zoned.zone_size=131072,zoned.zone_capacity=131072,zoned.max_open=0,zoned.max_active=0,bus=nvme2
```



| 参数                                                         | 意义                                               |
| ------------------------------------------------------------ | -------------------------------------------------- |
| -smp 4                                                       | 最大支持4个CPU                                     |
| -hda ubuntu.qcow2                                            | 设置启动盘 hda head disk assembly                  |
| -net user,hostfwd=tcp:127.0.0.1:7777-:22                     | 将机器的22端口映射到物理机的7777端口               |
| ,hostfwd=tcp:127.0.0.1:2222-:2000                            | 2000端口映射到物理机的2222端口                     |
| -net nic                                                     | 设置网卡                                           |
| -drive file=znsssd.qcow2,id=mynvme,format=raw,if=none        | 设置磁盘映像，设置id，格式是raw，网络接口没有      |
| -device nvme,serial=baz,id=nvme2                             | 设置nvme接口                                       |
| -device nvme-ns,id=ns2,drive=mynvme,nsid=2,                  | 为了支持多个命名空间，必须使用nvme-ns设备          |
| logical_block_size=4096,physical_block_size=4096,zoned=true,zoned.zone_size=131072, | 设置逻辑空间，物理空间，同时这里定义了分区命名空间 |
| zoned.zone_capacity=131072,zoned.max_open=0,zoned.max_active=0,bus=nvme2 | 使用bus参数将命名空间附加到特定设备                |

加这么多参数的目的是为了设置模拟一下nvme的操作，以及映射端口，实际上使用

```
./qemu-system-x86_64 -name znstest -m 8G -smp 4 -hda ubuntu.qcow2
```

命令就可以直接把系统运行起来。

运行起来的qemu窗口这样，按回车会有反应的。

![image-20221114143726186](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221114143726186.png)

### 6. 使用mobaXterm进行外部连接：

![image-20221114144116946](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221114144116946.png)

### 7. 查看我们的nvme设备：

![image-20221114144238313](https://hijack.oss-cn-chengdu.aliyuncs.com/typoraimg/image-20221114144238313.png)

### 8. 用nvme cli命令查看zns ssd设备信息

如果没有nvmecli可以使用apt下载

![image-20221114144610727](C:/Users/dell/AppData/Roaming/Typora/typora-user-images/image-20221114144610727.png)





## **四、实验结论和心得体会**

1. 学习了qemu的基本原理和使用方法。
2. 在qemu上成功安装Ubuntu系统。
3. 成功模拟了nvme设备以及zns ssd设备。
